<!DOCTYPE HTML>
<!-- 
	Phantom by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
  
-->
<html>
	<head>
		<title>Home</title>
        <meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="icon" href="../images/logocrop.png" />
        <link rel="stylesheet" href="../assets/css/main.css" />
        <noscript><link rel="stylesheet" href="../assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-preload" onload="initDates()">
		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
					<header id="header">
							
						<div class="inner">


								<a href="index.html" class="logo">
									<span class="symbol"><img src="loginAssets/images/img-01.png" alt="" /></span><span class="title"></span>
								</a>

							<!-- Nav -->
								<nav>
									<ul>
										<li><a href="#menu">Menu</a></li>
									</ul>
								</nav>

						</div>
					</header>

				<!-- Menu -->
					
				<nav id="menu">
                    <h2>Menu</h2>
                    <ul>
                      <li><a href="index.html">Home</a></li>
                      <li><a href="contest1.html">Contest</a></li>
                      <li><a href="leaderboard.html">Leaderboard</a></li>
                      <li><a href="rules.html">Rules</a></li>
                      <li><a href="archive.html">Archive</a></li>
                      <li><a href="hof.html">Hall of Fame</a></li>
                      <li><a href="profile.html">Your Profile</a></li>
                      <li><a href="../index.html"><i class="	fas fa-angle-left" style="font-size:18px"></i><b style="font-size:22px; margin-left:8px">Back</b></a></li>
                    </ul>
                </nav>
				<!-- Main -->
					<div id="main"> 
					    <div class="inner">
                            <div id = "contest"> 
							    <header>
                                    <button onclick="setStart()">Set Start Time</button>
                                    <button onclick="setEnd()">Set End Time</button>
								    <h1 id="heading">Welcome to the Competition!<br /></h1>
                                    <h2 id="leaderboardrefer" style="display:none">Final results are posted on the leaderboard</h2>
                                    <h3 id="timeuntil"></h3>
							    </header>

                                <div id="submission" style="display:none">
                                    <style>
                                        h2.label {margin-bottom: 5px}
                                        a.problemslink {
                                        font-weight: bold;
                                        font-size: 25px;
                                        display: inline-block;
                                        margin-bottom: 40px;
                                    }
                                    input {
                                        margin-bottom: 15px
                                    }
                                    </style>
                                
                                    <table>
                                        <tr>
                                            <td>Rank</td>
                                            <td>Username</td>
                                            <td>Score</td>
                                            <td>P1</td>
                                            <td>P2</td>
                                            <td>P3</td>
                                            <td>P4</td>
                                            <td>P5</td>
                                            <td>P6</td>
                                            <td>P7</td>
                                        </tr>
                                        <tr>
                                            <td id="tableRank">0</td>
                                            <td id="tableUser">Blank</td>
                                            <td id="tableTotal">0</td>
                                            <td id="tableq1">0</td>
                                            <td id="tableq2">0</td>
                                            <td id="tableq3">0</td>
                                            <td id="tableq4">0</td>
                                            <td id="tableq5">0</td>
                                            <td id="tableq6">0</td>
                                            <td id="tableq7">0</td>
                                        </tr>
                                    </table>
                                    <h2 id="timer"></h2>
                                    <p>The link to the problems document is attached below:</p>
                                    <a class="problemslink" target="_blank" id="problems">Problem File</a>
                                    
                                    <h2 class="label" id="q1label"></h2>
                                    <input type="text" name="name" id="q1" placeholder="Answer" maxlength = "9"/>
                                    <button id="q1button" onclick="answer('q1')">Submit</button>
                                    <p id="q1error"></p>

                                    <h2 class="label" id="q2label"></h2>
                                    <input type="text" name="name" id="q2" placeholder="Answer" maxlength = "9"/>
                                    <button id="q2button" onclick="answer('q2')">Submit</button>
                                    <p id="q2error"></p>

                                    <h2 class="label" id="q3label"></h2>
                                    <input type="text" name="name" id="q3" placeholder="Answer" maxlength = "9"/>
                                    <button id="q3button" onclick="answer('q3')">Submit</button>
                                    <p id="q3error"></p>

                                    <h2 class="label" id="q4label"></h2>
                                    <input type="text" name="name" id="q4" placeholder="Answer" maxlength = "9"/>
                                    <button id="q4button" onclick="answer('q4')">Submit</button>
                                    <p id="q4error"></p>

                                    <h2 class="label" id="q5label"></h2>
                                    <input type="text" name="name" id="q5" placeholder="Answer" maxlength = "9"/>
                                    <button id="q5button" onclick="answer('q5')">Submit</button>
                                    <p id="q5error"></p>

                                    <h2 class="label" id="q6label"></h2>
                                    <input type="text" name="name" id="q6" placeholder="Answer" maxlength = "9"/>
                                    <button id="q6button" onclick="answer('q6')">Submit</button>
                                    <p id="q6error"></p>

                                    <h2 class="label" id="q7label"></h2>
                                    <input type="text" name="name" id="q7" placeholder="Answer" maxlength = "9"/>
                                    <button id="q7button" onclick="answer('q7')">Submit</button>
                                    <p id="q7error"></p>
                                </div> 
                            </div>  
                        </div>
                    </div>

				<!-- Footer -->
				<footer id="footer">
						<div class="inner">
							<section>
								<h2>Get in touch</h2>
								<form method="post" action="#">
									<div class="fields">
										<div class="field half">
											<input type="text" name="name" id="name" placeholder="Name" />
										</div>
										<div class="field half">
											<input type="email" name="email" id="email" placeholder="Email" />
										</div>
										<div class="field">
											<textarea name="message" id="message" placeholder="Message"></textarea>
										</div>
									</div>
									<ul class="actions">
										<li><input type="submit" value="Send" class="primary" /></li>
									</ul>
								</form>
							</section>
							<section>
								<h2>Follow</h2>
								<ul class="icons">
									<li><a href="mailto:cncmathgroup@gmail.com" class="icon solid style2 fa-envelope"><span class="label">Email</span></a></li>
								</ul>
							</section>
							<ul class="copyright">
								<li>&copy; CNCM. All rights reserved</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
							</ul>
						</div>
					</footer>

			</div>

		<!-- Scripts -->
        <script src="../assets/js/jquery.min.js"></script>
        <script src="../assets/js/browser.min.js"></script>
        <script src="../assets/js/breakpoints.min.js"></script>
        <script src="../assets/js/util.js"></script>
        <script src="../assets/js/main.js"></script>
      

        <!-- TODO: Add SDKs for Firebase products that you want to use
            https://firebase.google.com/docs/web/setup#available-libraries -->
        <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-auth.js"></script>

        <!-- Initialize Firebase -->
        <script src="/__/firebase/init.js"></script>

        <script>
            // Setvar startDate = new Date("June 13var startDate = new Date("June 13 the date we're counting down to
            var startDate = new Date("July 01, 2020 14:00:00").getTime();
            var countDownDate = new Date("July 01, 2020 15:00:00").getTime();
            
            var CurrentUserId;
            
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                // User is signed in.
                var displayName = user.displayName;
                var email = user.email;
                var emailVerified = user.emailVerified;
                var photoURL = user.photoURL;
                var isAnonymous = user.isAnonymous;
                currentUserId = user.uid;
                var providerData = user.providerData;

                if (!emailVerified) {
                    window.location = "login.html"
                }

                userboard();


                let questions = ["q1", "q2", "q3", "q4", "q5", "q6", "q7"]
                var reference = firebase.database().ref("Competitors/"+currentUserId)

                questions.forEach(function(question) {
                    reference.once("value").then(function(snapshot) {
                        let attempts = snapshot.child(question + "/Attempts").val()
                        let prevanswer = snapshot.child(question + "/Submission").val()
                        let solved = snapshot.child(question + "/Solved").val()


                        if (solved) {
                            document.getElementById(question +"error").style.color = "green"
                            document.getElementById(question).disabled = true 
                            document.getElementById(question).placeholder = "Correct!"
                            document.getElementById(question).style.backgroundColor = "#c5ffa2"
                            document.getElementById(question + "button").disabled = true 
                        } else { 
                            if (attempts == null) {

                            } else {
                                document.getElementById(question).placeholder = "Current Answer: " + prevanswer
                                document.getElementById(question + "button").innerHTML = "Submit (" + attempts.toString() + " attempts left)"

                                if (attempts < 5) {
                                    document.getElementById(question +"error").innerHTML = "Incorrect Answer"
                                    document.getElementById(question +"error").style.color = 'red'
                                }
                                if (attempts <= 0) {
                                    document.getElementById(question).disabled = true 
                                    document.getElementById(question).placeholder = "OUT OF ATTEMPTS, Current Answer: " + prevanswer
                                    document.getElementById(question).style.backgroundColor = "#f0f0f0"

                                    document.getElementById(question + "button").disabled = true 
                                }
                            }
                        }
                    })
                })
                
                firebase.database().ref("Contest/pointValues").once("value").then(function(snapshot) {
                    pointvalues = snapshot.val()
                    
                    for (var n = 1; n <= 7; n++) {
                        document.getElementById("q" + n.toString() + "label").innerHTML = n.toString() + ". " + pointvalues[n-1].toString() + "p"
                    }
                })
                // ...
                } else {
                    // User is signed out.
                    //document.getElementById("field1").innerHTML = "Signed out";
                    window.location = "login.html"
                }
            });
            
            //   function initDates() {
            //     firebase.database().ref("Contest").once("value").then(function(snapshot) {
            //       var startString = snapshot.child("startTime").val()
            //       var endString = snapshot.child("endTime").val()

            //       startDate = new Date(startString).getTime();
            //       countDownDate = new Date(endString).getTime();
            //     })
            //   }

            function setStart() {
                startDate = new Date(prompt("The format is: July 01, 2020 14:00:00")).getTime()
            }

            function setEnd() {
                countDownDate = new Date(prompt("The format is: July 01, 2020 14:00:00")).getTime()
            }
            
            async function userboard() {
                let questions = ["q1", "q2", "q3", "q4", "q5", "q6", "q7"]

                var reference = firebase.database().ref("Competitors/"+currentUserId)


                var totalscore = 0;
                var rank = 0;
                var user = firebase.auth().currentUser;
                var name = user.displayName;

                await reference.child("totalscore").once("value").then(function(snapshot) {
                    totalscore = parseInt(snapshot.val());
                });

                await reference.child("rank/Current").once("value").then(function(snapshot) {
                    rank = parseInt(snapshot.val());
                });

                if (!totalscore) {
                    totalscore = 0;
                }

                if (!rank) {
                    rank = 0;
                }

                questions.forEach(function(question) {
                    reference.once("value").then(function(snapshot) {
                        let score = parseInt(snapshot.child(question + "/Score").val());
                        var qnumber = parseInt(question.replace("q",""));
                        var solved = snapshot.child(question+"/Solved").val();
                        if (!score) {
                            score = 0;
                        }
                        if (solved) {
                            document.getElementById("table"+question).style.backgroundColor = "#c5ffa2";
                        }
                        document.getElementById("table"+question).innerHTML = score;
                    })
                });

                document.getElementById("tableUser").innerHTML = name;
                document.getElementById("tableTotal").innerHTML = totalscore;
                document.getElementById("tableRank").innerHTML = rank;
                document.getElementById("tableTotal").style.fontWeight = "900";
            }
            
            function hide() {
                var x = document.getElementById("contest");
                x.style.display = "none";
            }

            
            async function showProblems() {
                await firebase.database().ref("Contest").once('value').then(async function(info) {
                    const value = await info.child("link").val();
                    document.getElementById("problems").href = value;
                }); 
            }

            function answer(question) {
                //question = q1, q2,...
                var x = document.getElementById(question).value;

                if(isNaN(x)) {
                    document.getElementById(question + "error").innerHTML = "Your answer must be an integer!";
                    document.getElementById(question).value = ""
                } else if (x == "") {
                    document.getElementById(question + "error").innerHTML = "Your answer must be an integer!";
                    document.getElementById(question).value = ""
                } else {
                    solve(x, question);
                }
            }
                
            async function solve(x, question) {
                var now = new Date().getTime();

                var distance = countDownDate - now;

                var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                var scoreTime = 60 * hours + minutes + 1;
                
                var duration = 1
                var penalty = 1
                var pointvalues = []
                
                await firebase.database().ref("Contest").once("value").then(function(snapshot) {
                    duration = snapshot.child("duration").val()
                    penalty = snapshot.child("penalty").val()
                    pointvalues = snapshot.child("pointValues").val()
                })
                
                var qnumber = parseInt(question.replace("q",""));

                var user = firebase.auth().currentUser;
                var reference = firebase.database().ref("Competitors/"+currentUserId)
                
            //     var answer = 0;
                
            //     await firebase.database().ref("Answers").once("value").then(function(snapshot) {
            //         answer = snapshot.child(question).val();
            //     });
                
                var solved;
                await reference.child(question + "/Solved").once("value").then(function(snapshot) {
                    solved = snapshot.val()
                });
                
                var totalscore = 0;
                await reference.child("totalscore").once("value").then(function(snapshot) {
                    totalscore = snapshot.val();
                });
                
                if (!solved) {
                    reference.child(question + "/Attempts").once("value").then(async function(snapshot) {
                        let attempts = snapshot.val()

                        //null means there are 5 attempts
                        if (attempts == null) { 
                            attempts = 5
                        }
                        attempts -= 1

                        let questionreference = reference.child(question)

                        questionreference.child("Answers").update({[(4 - attempts).toString()]: x})
                        questionreference.child("AnswerTimes").update({[(4 - attempts).toString()]: scoreTime})

                        document.getElementById(question + "button").innerHTML = "Submit (" + attempts.toString() + " attempts left)"

                        var test = false;

                        var backgroundProcess = firebase.functions().httpsCallable('backgroundProcess');

                        await backgroundProcess({answer: x, question: question}).then(function(result) {
                        test = result.data.correct;
                        
                        if (attempts >= 0) {
                            document.getElementById(question).value = ""
                            document.getElementById(question).placeholder = "Current Answer: " + x

                            reference.update({name: user.displayName, email: user.email});
                            questionreference.update({Time: scoreTime, Submission: x});

                            if (test) {
                                document.getElementById(question +"error").innerHTML = "Correct Answer!"
                                document.getElementById(question +"error").style.color = "green"
                                document.getElementById(question).disabled = true 
                                document.getElementById(question).placeholder = "Correct!"
                                document.getElementById(question).style.backgroundColor = "#c5ffa2"

                                var newscore = parseInt(pointvalues[qnumber - 1] * (0.5 + 0.5 * scoreTime / duration) - penalty * (4 - attempts))
                                questionreference.update({Score: newscore})

                                var changescore = parseInt(pointvalues[qnumber - 1] * (0.5 + 0.5 * scoreTime / duration))

                                totalscore += changescore;

                                reference.update({totalscore: totalscore});

                                document.getElementById(question + "button").disabled = true 
                                questionreference.update({Solved: true});
                            } else {
                                document.getElementById(question + "error").innerHTML = "Incorrect Answer"
                                document.getElementById(question + "error").style.color = "red"

                                var newscore = parseInt(-1 * penalty * (5 - attempts))
                                questionreference.update({Score: newscore})

                                totalscore -= penalty;

                                reference.update({totalscore: totalscore});
                            }
                        } else if (attempts <= 0) {
                            document.getElementById(question).disabled = true 
                            document.getElementById(question).placeholder = "OUT OF ATTEMPTS, Current Answer: " + x
                            document.getElementById(question).style.backgroundColor = "#f0f0f0"

                            document.getElementById(question + "button").disabled = true 
                        }
                        
                        userboard();
                        })
                        
                        questionreference.update({Attempts: attempts})
                    })
                }
            }
                
            // Update the count down every 1 second
            var u = setInterval(function() {
                var now = new Date().getTime();
                const distance = startDate - now;
                
                var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                if (distance < 0) {
                    document.getElementById("timeuntil").style.display = "none"
                    document.getElementById("submission").style.display = "inline"

                    if (document.getElementById("problems").href == "") {
                        showProblems();
                    }
                } else {
                    document.getElementById("timeuntil").innerHTML = "Round 1 begins in: " + days + "d " + hours + "h "
                    + minutes + "m " + seconds + "s ";
                }
                
            }, 1000);
            
            var x = setInterval(function() {

                // Get today's date and time
                var now = new Date().getTime();

                // Find the distance between now and the count down date
                var distance = countDownDate - now;

                // Time calculations for days, hours, minutes and seconds
                var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((distance % (1000 * 60)) / 1000);

                // Display the result in the element with id="timer"
                document.getElementById("timer").innerHTML = "Time Left: " + hours + "h " + minutes + "m " + seconds + "s ";

                // If the count down is finished, write some text
                if (distance < 0) {
                    document.getElementById("submission").style.display = "none"
                    document.getElementById("heading").innerHTML = "The competition has ended!"
                    document.getElementById("leaderboardrefer").style.display = "inline"
                    clearInterval(x);
                    clearInterval(u)
                }
            }, 1000);
        </script>
	</body>
</html>